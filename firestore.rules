  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      
      // ==========================================
      // FUNCIONES AUXILIARES
      // ==========================================
      // Roles del sistema:
      // 1 = Administrador (control total)
      // 2 = Staff/Preceptor (gestión de asistencias y cursos)
      // 3 = Estudiante (solo lectura de sus datos)
      // 4 = Docente (gestión de calificaciones y asistencias)
      // 5 = Familia (lectura de datos de hijos, crea retiros)
      // 6 = Seguridad (valida retiros)
      // 7 = Super Administrador (control absoluto, pase de año, gestión de admins)
      // ==========================================
      
      // Verificar que un userId existe y obtener su rol
      function getUserRole(userId) {
        return (exists(/databases/$(database)/documents/users/$(userId)) && 'role' in get(/databases/$(database)/documents/users/$(userId)).data) ? get(/databases/$(database)/documents/users/$(userId)).data.role : null;
      }
      
      // Verificar si es administrador (role == 1)
      function isAdmin(userId) {
        return userId != null && getUserRole(userId) == 1;
      }
      
      // Verificar si es super administrador (role == 7)
      function isSuperAdmin(userId) {
        return userId != null && getUserRole(userId) == 7;
      }
      
      // Verificar si es cualquier tipo de admin (1 o 7)
      function isAnyAdmin(userId) {
        return userId != null && getUserRole(userId) in [1, 7];
      }
      
      // Verificar si es staff/preceptor (role == 2)
      function isStaffOnly(userId) {
        return userId != null && getUserRole(userId) == 2;
      }
      
      // Verificar si puede gestionar asistencias (SuperAdmin, Admin, Staff o Docente)
      function canManageAttendance(userId) {
        return userId != null && getUserRole(userId) in [1, 2, 4, 7];
      }
      
      // Verificar si es estudiante (role == 3)
      function isStudent(userId) {
        return userId != null && getUserRole(userId) == 3;
      }
      
      // Verificar si es docente (role == 4)
      function isTeacher(userId) {
        return userId != null && getUserRole(userId) == 4;
      }
      
      // Verificar si es familia (role == 5)
      function isFamily(userId) {
        return userId != null && getUserRole(userId) == 5;
      }
      
      // Verificar si es seguridad (role == 6)
      function isSecurity(userId) {
        return userId != null && getUserRole(userId) == 6;
      }
      
      // Verificar si gradesLoadingEnabled está habilitado
      function isGradesLoadingEnabled() {
        return exists(/databases/$(database)/documents/system/settings) &&
              'gradesLoadingEnabled' in get(/databases/$(database)/documents/system/settings).data &&
              get(/databases/$(database)/documents/system/settings).data.gradesLoadingEnabled == true;
      }
      
      // Verificar si el usuario puede crear calificaciones
      // Permite SuperAdmin y Admin siempre, o Docente si gradesLoadingEnabled está habilitado
      // Si gradesLoadingEnabled no está configurado, también permite a docentes (fallback)
      function canCreateGrade(userId) {
        // Si no hay userId, rechazar
        return userId != null && (
          // SuperAdmin y Admin siempre pueden crear
          isAnyAdmin(userId) || 
          // Docente puede crear si:
          (isTeacher(userId) && (
            // El documento de settings no existe (modo permisivo por defecto)
            !exists(/databases/$(database)/documents/system/settings) ||
            // O si existe y gradesLoadingEnabled está habilitado
            isGradesLoadingEnabled()
          ))
        );
      }
      
      // Extraer userId del request (asumiendo que se pasa como campo en el documento)
      function getRequestUserId() {
        // Para updates, primero intenta obtener updatedByUid
        // Para creates, usa createdByUid
        return request.resource.data.updatedByUid != null ? 
              request.resource.data.updatedByUid : 
              (request.resource.data.createdByUid != null ? 
                request.resource.data.createdByUid : 
                (request.resource.data.userId != null ? 
                request.resource.data.userId : null));
      }
      
      // ==========================================
      // COLECCIÓN DE USUARIOS
      // ==========================================
      match /users/{userId} {
        // Lectura: Todos pueden leer (filtrado en cliente según contexto)
        // - Admin: puede ver todos
        // - Staff: puede ver todos
        // - Docente: puede ver estudiantes de sus materias
        // - Estudiante: puede ver su perfil y profesores
        // - Familia: puede ver sus hijos
        // - Seguridad: puede ver su perfil
        allow read: if true;
        
        // Crear: SuperAdmin y Admin pueden crear usuarios
        // La validación de permisos específicos se hace en el cliente
        // El uid debe coincidir con el documentId
        allow create: if request.resource.data.keys().hasAll(['name', 'role', 'mail', 'password', 'uid']) &&
                        request.resource.data.role is int &&
                        request.resource.data.name is string &&
                        request.resource.data.mail is string &&
                        request.resource.data.password is string &&
                        request.resource.data.uid is string &&
                        request.resource.data.uid == userId;
        
        // Actualizar: SuperAdmin y Admin pueden actualizar usuarios
        // SuperAdmin puede editar/suspender otros admins, Admin regular no puede
        // La validación de permisos específicos se hace en el cliente
        // Los campos son opcionales pero si están presentes deben tener el tipo correcto
        // NOTA: Para pase de año, courseId puede ser null al eliminar curso de egresados
        allow update: if (!('uid' in request.resource.data) || request.resource.data.uid == userId) &&
                        (!('uid' in request.resource.data) || request.resource.data.uid is string) &&
                        (!('role' in request.resource.data) || request.resource.data.role is int) &&
                        (!('name' in request.resource.data) || request.resource.data.name is string) &&
                        (!('mail' in request.resource.data) || request.resource.data.mail is string) &&
                        (!('password' in request.resource.data) || request.resource.data.password is string) &&
                        (!('dni' in request.resource.data) || request.resource.data.dni is int) &&
                        (!('asig' in request.resource.data) || request.resource.data.asig is int) &&
                        (!('level' in request.resource.data) || request.resource.data.level is int) &&
                        (!('childId' in request.resource.data) || request.resource.data.childId is string) &&
                        (!('childrenIds' in request.resource.data) || request.resource.data.childrenIds is list) &&
                        (!('courseId' in request.resource.data) || request.resource.data.courseId is string || request.resource.data.courseId == null) &&
                        (!('division' in request.resource.data) || request.resource.data.division is string) &&
                        (!('status' in request.resource.data) || request.resource.data.status in ['pending', 'active', 'suspended', 'egresado']) &&
                        (!('egresadoDate' in request.resource.data) || request.resource.data.egresadoDate is number) &&
                        (!('egresadoYear' in request.resource.data) || request.resource.data.egresadoYear is int);
        
        // Eliminar: SuperAdmin y Admin pueden eliminar usuarios
        // SuperAdmin puede eliminar otros admins, Admin regular no puede
        // La validación de permisos específicos se hace en el cliente
        allow delete: if true;
      }
      
      // ==========================================
      // MENSAJES DIRECTOS
      // ==========================================
      match /direct_messages/{messageId} {
        allow read: if true; // Validación en cliente basada en participants
        
        allow create: if request.resource.data.keys().hasAll(['fromUid', 'toUid', 'body', 'createdAt', 'participants']) &&
                        request.resource.data.fromUid is string &&
                        request.resource.data.toUid is string &&
                        request.resource.data.participants is list &&
                        request.resource.data.fromUid in request.resource.data.participants &&
                        request.resource.data.toUid in request.resource.data.participants;
        
        allow update, delete: if false; // Los mensajes no se editan ni eliminan
      }
      
      // ==========================================
      // CHATS Y MENSAJES
      // ==========================================
      match /chats/{chatId} {
        allow read: if true; // Validación en cliente basada en participants
        
        allow create: if request.resource.data.keys().hasAll(['participants', 'createdAt']) &&
                        request.resource.data.participants is list &&
                        request.resource.data.participants.size() == 2;
        
        allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastMessage', 'lastMessageAt', 'unreadCount', 'isActive']);
        
        allow delete: if false;
        
        // Mensajes dentro de chats
        match /messages/{messageId} {
          allow read: if true;
          
          allow create: if request.resource.data.keys().hasAll(['fromUid', 'body', 'createdAt']) &&
                          request.resource.data.fromUid is string &&
                          request.resource.data.body is string;
          
          allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy']);
          
          allow delete: if false;
        }
      }
      
      // ==========================================
      // ANUNCIOS
      // ==========================================
      match /announcements/{announcementId} {
        // Lectura: Todos pueden leer (filtrado por audience en el cliente)
        allow read: if true;
        
        // Crear: SuperAdmin (7) y Admin (1) pueden crear anuncios
        // La validación de permisos se hace en el cliente
        allow create: if request.resource.data.keys().hasAll(['title', 'audience', 'createdAt', 'createdByUid']) &&
                        request.resource.data.title is string &&
                        request.resource.data.audience is string &&
                        request.resource.data.createdByUid is string;
        
        // Actualizar: Los anuncios no se pueden editar (solo crear y eliminar)
        allow update: if false;
        
        // Eliminar: SuperAdmin (7) y Admin (1) pueden eliminar anuncios
        // La validación de permisos se hace en el cliente
        allow delete: if true;
      }
      
      // ==========================================
      // CONFIGURACIÓN DEL SISTEMA
      // ==========================================
      match /system/settings {
        allow read: if true;
        
        allow create: if request.resource.data.keys().hasAll(['gradesLoadingEnabled', 'updatedAt', 'createdAt']) &&
                        request.resource.data.gradesLoadingEnabled is bool &&
                        request.resource.data.updatedAt is number &&
                        request.resource.data.createdAt is number;
        
        allow update: if request.resource.data.keys().hasAll(['gradesLoadingEnabled', 'updatedAt']) &&
                        request.resource.data.gradesLoadingEnabled is bool &&
                        request.resource.data.updatedAt is number;
        // Nota: La validación de que solo admin puede modificar se hace en el cliente
      }
      
      // ==========================================
      // ASISTENCIA
      // ==========================================
      match /attendance/{attendanceId} {
        // Lectura: Todos los usuarios autenticados (filtrado en cliente)
        allow read: if true;
        
        // Crear: SuperAdmin (7), Admin (1), Staff (2) o Docente (4) pueden crear asistencias
        // Validación simplificada: verificar que el createdByUid existe y tiene rol correcto
        allow create: if request.resource.data.keys().hasAll(['date', 'studentUid', 'courseLevel', 'status', 'createdByUid', 'createdAt']) &&
                        request.resource.data.date is string &&
                        request.resource.data.studentUid is string &&
                        request.resource.data.courseLevel is int &&
                        request.resource.data.status is string &&
                        request.resource.data.createdByUid is string &&
                        request.resource.data.createdAt is number &&
                        // Verificar que el usuario existe y tiene rol 1, 2, 4 o 7
                        exists(/databases/$(database)/documents/users/$(request.resource.data.createdByUid)) &&
                        get(/databases/$(database)/documents/users/$(request.resource.data.createdByUid)).data.role in [1, 2, 4, 7];
        
        // Actualizar: SuperAdmin (7), Admin (1), Staff (2) o Docente (4) pueden actualizar asistencias
        // Solo se permite actualizar status, updatedAt y updatedByUid
        allow update: if (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt', 'updatedByUid']) ||
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt'])) &&
                        // Verificar el usuario que actualiza
                        (
                          // Si hay updatedByUid, verificar ese
                          (request.resource.data.updatedByUid != null &&
                           exists(/databases/$(database)/documents/users/$(request.resource.data.updatedByUid)) &&
                           get(/databases/$(database)/documents/users/$(request.resource.data.updatedByUid)).data.role in [1, 2, 4, 7]) ||
                          // Si no hay updatedByUid pero hay createdByUid en el recurso existente
                          (request.resource.data.updatedByUid == null &&
                           exists(/databases/$(database)/documents/users/$(resource.data.createdByUid)) &&
                           get(/databases/$(database)/documents/users/$(resource.data.createdByUid)).data.role in [1, 2, 4, 7])
                        );
        
        // Eliminar: Deshabilitado
        allow delete: if false;
      }
      
      // ==========================================
      // CALIFICACIONES
      // ==========================================
      match /grades/{gradeId} {
        // Lectura: Todos pueden leer (filtrado en cliente)
        // - Admin: puede ver todas
        // - Docente: puede ver de sus materias
        // - Estudiante: puede ver sus propias (solo published=true)
        // - Familia: puede ver de sus hijos (solo published=true)
        allow read: if true;
        
        // Crear: SuperAdmin (7) y Admin (1) siempre, Docente (4) si gradesLoadingEnabled=true
        // Staff (2), Estudiante (3), Familia (5), Seguridad (6) NO pueden crear
        allow create: if request.resource.data.keys().hasAll(['studentUid', 'subjectId', 'courseLevel', 'period', 'grade', 'createdByUid', 'createdAt', 'published']) &&
                        request.resource.data.studentUid is string &&
                        request.resource.data.subjectId is int &&
                        request.resource.data.courseLevel is int &&
                        request.resource.data.period is string &&
                        request.resource.data.grade is string &&
                        request.resource.data.createdByUid is string &&
                        request.resource.data.createdAt is number &&
                        request.resource.data.published is bool &&
                        // Verificar que el usuario existe
                        request.resource.data.createdByUid != null &&
                        exists(/databases/$(database)/documents/users/$(request.resource.data.createdByUid)) &&
                        // Verificar permisos: SuperAdmin (role 7) y Admin (role 1) siempre pueden crear
                        (getUserRole(request.resource.data.createdByUid) in [1, 7] ||
                          // O Docente (role 4) - cuando es docente, verificar si puede crear
                          (getUserRole(request.resource.data.createdByUid) == 4 && (
                            // Si el documento de settings no existe, permitir por defecto (modo permisivo)
                            !exists(/databases/$(database)/documents/system/settings) ||
                            // O si existe y gradesLoadingEnabled está habilitado, permitir
                            (exists(/databases/$(database)/documents/system/settings) && isGradesLoadingEnabled())
                          )));
        
        // Actualizar: SuperAdmin (7) y Admin (1) pueden cambiar published (publicar boletines)
        // Solo se permite actualizar published y updatedByUid
        // Docentes NO pueden publicar boletines
        allow update: if (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['published', 'updatedByUid']) ||
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['published'])) &&
                        isAnyAdmin(getRequestUserId());
        
        // Eliminar: Deshabilitado para todos
        allow delete: if false;
      }
      
      // ==========================================
      // MATERIAS (SUBJECTS)
      // ==========================================
      match /subjects/{subjectId} {
        // Lectura: Todos pueden leer (necesario para horarios, asignaciones, etc)
        allow read: if true;
        
        // Crear: SuperAdmin (7) y Admin (1) pueden crear materias
        // La validación de permisos se hace en el cliente
        allow create: if request.resource.data.keys().hasAll(['name', 'subjectId', 'courseLevel', 'teacherUid', 'createdByUid']) &&
                        request.resource.data.name is string &&
                        request.resource.data.subjectId is int &&
                        request.resource.data.courseLevel is int &&
                        request.resource.data.teacherUid is string &&
                        request.resource.data.createdByUid is string &&
                        request.resource.data.studentUids is list;
        
        // Actualizar: SuperAdmin (7), Admin (1) y Docente (4) pueden actualizar
        // SuperAdmin y Admin pueden cambiar todo, Docente solo puede actualizar estudiantes asignados
        // La validación de permisos se hace en el cliente
        allow update: if request.resource.data.diff(resource.data).affectedKeys().hasAny(['teacherUid', 'studentUids', 'updatedAt']) ||
                        (request.resource.data.keys().hasAll(['name', 'subjectId', 'courseLevel', 'teacherUid']));
        
        // Eliminar: SuperAdmin (7) y Admin (1) pueden eliminar materias
        // La validación de permisos se hace en el cliente
        allow delete: if true;
      }
      
      // ==========================================
      // HORARIOS (SCHEDULES)
      // ==========================================
      match /schedules/{scheduleId} {
        allow read: if true;
        
        allow create: if request.resource.data.keys().hasAll(['dayOfWeek', 'startTime', 'endTime', 'subjectId', 'courseLevel', 'createdByUid']) &&
                        request.resource.data.dayOfWeek is int &&
                        request.resource.data.startTime is string &&
                        request.resource.data.endTime is string &&
                        request.resource.data.subjectId is int &&
                        request.resource.data.courseLevel is int &&
                        request.resource.data.createdByUid is string;
        
        allow update: if request.resource.data.diff(resource.data).affectedKeys().hasAny(['dayOfWeek', 'startTime', 'endTime', 'subjectId', 'courseLevel', 'updatedAt']);
        
        allow delete: if false;
      }
      
      // ==========================================
      // ASIGNACIONES DE DOCENTES (legacy, si se usa)
      // ==========================================
      match /subjectAssignments/{assignmentId} {
        allow read: if true;
        allow write: if request.resource.data.keys().hasAll(['subjectId', 'courseLevel', 'teacherUid', 'createdByUid']);
      }
      
      match /teacherAssignments/{assignmentId} {
        allow read: if true;
        allow write: if request.resource.data.keys().hasAll(['subjectId', 'courseLevel', 'teacherUid', 'createdByUid']);
      }
      
      // ==========================================
      // CURSOS (COURSES)
      // ==========================================
      match /courses/{courseId} {
        // Lectura: Todos pueden leer (necesario para asignaciones)
        allow read: if true;
        
        // Crear: SuperAdmin (7) y Admin (1) pueden crear cursos
        allow create: if request.resource.data.keys().hasAll(['level', 'division', 'createdByUid', 'createdAt']) &&
                        request.resource.data.level is int &&
                        request.resource.data.division is string &&
                        request.resource.data.createdByUid is string &&
                        request.resource.data.createdAt is number &&
                        request.resource.data.studentUids is list &&
                        // Verificar que el usuario existe
                        exists(/databases/$(database)/documents/users/$(request.resource.data.createdByUid)) &&
                        // Verificar permisos: SuperAdmin (role 7) o Admin (role 1)
                        getUserRole(request.resource.data.createdByUid) in [1, 7];
        
        // Actualizar: SuperAdmin (7) y Admin (1) pueden actualizar cursos
        // Pueden cambiar studentUids, preceptorUid, division, level (para pase de año)
        allow update: if request.resource.data.diff(resource.data).affectedKeys().hasAny(['studentUids', 'preceptorUid', 'division', 'updatedAt', 'level']);
        
      // Eliminar: SuperAdmin (7) y Admin (1) pueden eliminar cursos
      // La validación de permisos se hace en el cliente
      allow delete: if true;
    }
    
    // ==========================================
    // RETIROS ANTICIPADOS (EARLY WITHDRAWALS)
    // ==========================================
    match /early_withdrawals/{withdrawalId} {
      // Lectura: Todos pueden leer (filtrado en cliente)
      // - Admin: puede ver todos
      // - Familia: puede ver los de sus hijos
      // - Seguridad: puede ver todos (para validar)
      allow read: if true;
      
      // Crear: Familia (5), SuperAdmin (7) y Admin (1) pueden crear retiros
      allow create: if request.resource.data.keys().hasAll([
                      'authorizerUid', 'authorizerName', 'studentUid', 'studentName',
                      'pickerName', 'pickerDni', 'pickerRelationship', 'withdrawalDate',
                      'withdrawalTime', 'reason', 'qrCode', 'status', 'createdAt',
                      'updatedAt', 'expiresAt'
                    ]) &&
                    request.resource.data.authorizerUid is string &&
                    request.resource.data.authorizerName is string &&
                    request.resource.data.studentUid is string &&
                    request.resource.data.studentName is string &&
                    (!('studentCourse' in request.resource.data) || request.resource.data.studentCourse is string) &&
                    (!('studentDivision' in request.resource.data) || request.resource.data.studentDivision is string) &&
                    request.resource.data.pickerName is string &&
                    request.resource.data.pickerDni is string &&
                    request.resource.data.pickerRelationship is string &&
                    request.resource.data.withdrawalDate is string &&
                    request.resource.data.withdrawalTime is string &&
                    request.resource.data.reason is string &&
                    request.resource.data.qrCode is string &&
                    request.resource.data.status is string &&
                    request.resource.data.createdAt is number &&
                    request.resource.data.updatedAt is number &&
                    request.resource.data.expiresAt is number &&
                    (isFamily(request.resource.data.authorizerUid) || 
                     isAnyAdmin(request.resource.data.authorizerUid));
      
      // Actualizar: 
      // - SuperAdmin (7) y Admin (1) pueden actualizar todo
      // - Seguridad (6) puede validar retiros (cambiar status)
      // - Familia (5) puede cancelar sus propios retiros
      // La validación de permisos específicos se hace en el cliente
      allow update: if true;
      
    // Eliminar: Deshabilitado para todos
    allow delete: if false;
  }
  }
}
